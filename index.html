
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program Status – Roadmap (Local & Single-User)</title>
  <style>
    /* ============ THEME ============ */
    :root {
      --bg: #0b1220;           /* deep navy */
      --panel: #0f172a;        /* slate */
      --panel-2: #111827;      /* darker */
      --text: #e5e7eb;         /* gray-200 */
      --muted: #94a3b8;        /* slate-400 */
      --border: #1f2937;       /* gray-800 */

      --accent: #22d3ee;       /* cyan-400 */
      --accent-2: #a78bfa;     /* violet-400 */
      --good: #22c55e;         /* green-500 */
      --warn: #60a5fa;         /* blue-400 */
      --bad:  #ef4444;         /* red-500 */
      --idle: #64748b;         /* slate-500 */
      --chip-bg: rgba(255,255,255,0.06);
      --shadow: 0 6px 18px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.04) inset;
    }

    /* Preset themes (you can switch from UI) */
    [data-theme="emerald"] {
      --accent: #34d399; --accent-2:#22d3ee;
    }
    [data-theme="sunset"] {
      --accent: #f59e0b; --accent-2:#f472b6;
    }
    [data-theme="crimson"] {
      --accent: #ef4444; --accent-2:#f59e0b;
    }
    [data-theme="azure"] {
      --accent: #60a5fa; --accent-2:#22d3ee;
    }

    /* ============ BASE ============ */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 600px at 70% -10%, rgba(167,139,250,0.18), transparent 60%),
                      radial-gradient(900px 600px at 10% 10%, rgba(34,211,238,0.15), transparent 60%),
                      var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color: var(--text);
    }
    a, button, select { font: inherit; color: inherit; }

    .wrapper {
      max-width: 1200px; margin: 0 auto; padding: 20px 16px 56px;
    }

    header.appbar {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to right, rgba(15,23,42,0.85), rgba(17,24,39,0.85));
      border-bottom: 1px solid var(--border);
    }
    .appbar .bar {
      max-width: 1200px; margin: 0 auto; padding: 12px 16px; display: flex; gap: 12px; align-items: center; justify-content: space-between;
    }
    .brand {
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: conic-gradient(from 200deg, var(--accent), var(--accent-2));
      box-shadow: var(--shadow);
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .btn {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px; border-radius: 10px; cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn:hover { border-color: rgba(255,255,255,0.22); }
    .btn.accent { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #0a0a0a; font-weight: 700; border: 0; }
    .btn.ghost { background: transparent; border: 1px dashed var(--border); color: var(--muted); }

    select.theme {
      padding: 8px 10px; border-radius: 10px; background: var(--panel);
      border: 1px solid var(--border); color: var(--text);
    }

    .legend {
      margin: 16px 0 8px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
      color: var(--muted);
    }
    .pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px;
      background: var(--chip-bg); border: 1px solid var(--border);
    }
    .k { width: 8px; height: 8px; border-radius: 50%; background: var(--idle); display: inline-block; }
    .k.g { background: var(--good); }
    .k.b { background: var(--bad); }
    .k.w { background: var(--warn); }

    .grid {
      display: grid; grid-template-columns: 340px 1fr; gap: 18px; align-items: start;
      margin-top: 12px;
    }

    /* Sidebar: phases list */
    .phases {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border); border-radius: 14px; padding: 10px; box-shadow: var(--shadow);
      position: sticky; top: 64px;
    }
    .phases h3 { margin: 6px 10px 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
    .phase-item {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin: 10px;
      background: var(--panel); cursor: pointer;
    }
    .phase-item.active { outline: 2px solid var(--accent); }
    .phase-top {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .phase-title { font-weight: 700; }
    .progressbar {
      height: 8px; background: rgba(255,255,255,0.06); border: 1px solid var(--border);
      border-radius: 999px; margin-top: 10px; overflow: hidden;
    }
    .progressbar > span { display: block; height: 100%; background: linear-gradient(to right, var(--accent), var(--accent-2)); width: 0%; }

    /* Main panel: steps & tasks */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid var(--border); border-radius: 14px; padding: 12px; box-shadow: var(--shadow);
    }

    .phase-headline {
      display: flex; align-items: center; justify-content: space-between; padding: 10px 10px 4px;
    }
    .status-badge {
      padding: 6px 10px; border-radius: 999px; font-weight: 600; letter-spacing: 0.2px;
      border: 1px solid var(--border);
      background: var(--chip-bg);
      color: var(--muted);
    }
    .status-badge.completed { color: var(--good); }
    .status-badge.blocked { color: var(--bad); }
    .status-badge.in_progress { color: var(--warn); }

    .step {
      border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin: 10px 6px;
      background: var(--panel-2);
    }
    .step-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .step-title { font-weight: 700; }
    .step-meta { display: flex; align-items: center; gap: 8px; color: var(--muted); }
    .step-status-chip {
      border: 1px solid var(--border); border-radius: 999px; padding: 4px 8px; font-size: 12px;
      background: var(--chip-bg);
    }
    .step-status-chip.completed { color: var(--good); }
    .step-status-chip.blocked { color: var(--bad); }
    .step-status-chip.in_progress { color: var(--warn); }

    .tasklist { margin-top: 10px; display: grid; gap: 8px; }
    .task {
      display: grid; grid-template-columns: 32px minmax(120px,1fr) auto; gap: 10px; align-items: center;
      border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; background: rgba(255,255,255,0.03);
    }
    .task .slot { display: flex; align-items: center; gap: 8px; }
    .task .title {
      background: transparent; border: 0; border-bottom: 1px dashed transparent; color: var(--text);
      padding: 2px 0; outline: none;
    }
    [data-edit="true"] .task .title { border-bottom-color: var(--border); }
    .chips { display: inline-flex; gap: 6px; }
    .chip {
      padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--chip-bg);
      cursor: pointer; font-size: 12px; color: var(--muted);
    }
    .chip.active.not_started { color: var(--idle); outline: 1px solid var(--idle); }
    .chip.active.in_progress { color: var(--warn); outline: 1px solid var(--warn); }
    .chip.active.completed { color: var(--good); outline: 1px solid var(--good); }
    .chip.active.blocked { color: var(--bad); outline: 1px solid var(--bad); }

    .divider { height: 1px; background: var(--border); margin: 10px 0; }

    .row-actions { display: flex; gap: 6px; }
    .iconbtn {
      width: 30px; height: 30px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--chip-bg); cursor: pointer;
    }
    .iconbtn:hover { border-color: rgba(255,255,255,0.22); }

    .muted { color: var(--muted); }
    .right { display: flex; gap: 8px; align-items: center; }

    .footer-actions {
      margin-top: 14px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
      color: var(--muted);
    }

    /* Print-friendly area marker */
    #exportTarget { padding: 6px; }

    /* Responsive */
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .phases { position: static; }
    }
  </style>
</head>
<body data-theme="azure">
  <header class="appbar">
    <div class="bar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Program Status — Roadmap</div>
          <div class="muted" style="font-size:12px;">Single-user • Local storage • No backend</div>
        </div>
      </div>
      <div class="controls">
        <select id="themePicker" class="theme" title="Theme">
          <option value="azure" selected>Theme: Azure</option>
          <option value="emerald">Theme: Emerald</option>
          <option value="sunset">Theme: Sunset</option>
          <option value="crimson">Theme: Crimson</option>
        </select>
        <button id="toggleEdit" class="btn">Edit</button>
        <button id="exportPNG" class="btn">Export PNG</button>
        <button id="exportPDF" class="btn">Export PDF</button>
        <button id="exportJSON" class="btn ghost">Export JSON</button>
        <button id="importJSON" class="btn ghost">Import JSON</button>
        <button id="resetData" class="btn ghost" title="Clear local data">Reset</button>
      </div>
    </div>
  </header>

  <div class="wrapper">
    <div class="legend">
      <span class="pill"><span class="k g"></span> Complete (✓)</span>
      <span class="pill"><span class="k w"></span> In Progress (➜)</span>
      <span class="pill"><span class="k"></span> Not Started (•)</span>
      <span class="pill"><span class="k b"></span> Blocked (✗)</span>
      <span class="muted">Tip: Toggle <b>Edit</b> to add/rename/delete items.</span>
    </div>

    <div id="exportTarget" class="grid">
      <!-- Sidebar phases list -->
      <aside class="phases" id="phasesSidebar" aria-label="Phases"></aside>

      <!-- Main content -->
      <section class="panel" id="mainPanel" aria-live="polite"></section>
    </div>

    <div class="footer-actions">
      <span>All changes are saved locally in your browser.</span>
    </div>
  </div>

  <!-- Dependencies for export (client-only) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/htmls</script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js<script>
    /**********************
     * Utility / Storage
     **********************/
    const LS_KEY = "roadmap_local_v1";
    const genId = () => Math.random().toString(36).slice(2,9);
    const nowISO = () => new Date().toISOString();

    const STATUS = ["not_started", "in_progress", "completed", "blocked"];
    const STATUS_LABEL = {
      not_started: "Not Started •",
      in_progress: "In Progress ➜",
      completed: "Completed ✓",
      blocked: "Blocked ✗",
    };

    function defaultData() {
      // Seed with 4 phases, no steps (you can add via UI)
      return {
        meta: { createdAt: nowISO(), updatedAt: nowISO(), title: "Program Status — Roadmap" },
        phases: [
          { id: genId(), title: "Phase 1", steps: [] },
          { id: genId(), title: "Phase 2", steps: [] },
          { id: genId(), title: "Phase 3", steps: [] },
          { id: genId(), title: "Phase 4", steps: [] },
        ],
        activePhaseId: null
      };
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return defaultData();
        const parsed = JSON.parse(raw);
        // lightweight validation
        if (!parsed.phases || !Array.isArray(parsed.phases)) return defaultData();
        return parsed;
      } catch (e) {
        console.warn("Failed reading localStorage, using defaults", e);
        return defaultData();
      }
    }
    function saveData() {
      data.meta.updatedAt = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      render(); // keep UI in sync
    }
    function resetData() {
      if (!confirm("This will clear your local data. Continue?")) return;
      localStorage.removeItem(LS_KEY);
      data = defaultData();
      render();
    }

    /**********************
     * Data / State
     **********************/
    let data = loadData();
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const appRoot = document.body;

    // activePhase selection default
    if (!data.activePhaseId && data.phases[0]) data.activePhaseId = data.phases[0].id;

    /**********************
     * Status aggregation
     **********************/
    function aggregateFromTasks(tasks) {
      if (!tasks || tasks.length === 0) return { status: "not_started", pct: 0 };
      const counts = { not_started:0, in_progress:0, completed:0, blocked:0 };
      tasks.forEach(t => counts[t.status] = (counts[t.status]||0) + 1);

      let status = "not_started";
      if (counts.blocked > 0) status = "blocked";
      else if (counts.completed === tasks.length) status = "completed";
      else if (counts.in_progress > 0 || (counts.completed > 0 && counts.completed < tasks.length)) status = "in_progress";

      const pct = Math.round((counts.completed / tasks.length) * 100);
      return { status, pct };
    }

    function aggregateStep(step) {
      return aggregateFromTasks(step.tasks || []);
    }
    function aggregatePhase(phase) {
      if (!phase.steps || phase.steps.length === 0) return { status: "not_started", pct: 0 };
      const stepAggs = phase.steps.map(aggregateStep);
      const pct = Math.round(stepAggs.reduce((a,s)=>a+s.pct,0) / stepAggs.length);
      // Determine phase status
      const anyBlocked = stepAggs.some(s => s.status === "blocked");
      const allCompleted = stepAggs.every(s => s.status === "completed");
      const anyInProgress = stepAggs.some(s => s.status === "in_progress");
      let status = "not_started";
      if (anyBlocked) status = "blocked";
      else if (allCompleted) status = "completed";
      else if (anyInProgress) status = "in_progress";
      else status = "not_started";
      return { status, pct };
    }

    /**********************
     * Rendering
     **********************/
    function renderPhasesSidebar() {
      const sb = $("#phasesSidebar");
      sb.innerHTML = `<h3>Phases</h3>`;
      data.phases.forEach(phase => {
        const agg = aggregatePhase(phase);
        const active = data.activePhaseId === phase.id ? "active" : "";
        const el = document.createElement("div");
        el.className = `phase-item ${active}`;
        el.innerHTML = `
          <div class="phase-top">
            <div class="phase-title">${escapeHtml(phase.title)}</div>
            <div class="status-badge ${agg.status}">${STATUS_LABEL[agg.status]}</div>
          </div>
          <div class="progressbar" aria-label="progress ${agg.pct}%"><span style="width:${agg.pct}%"></span></div>
        `;
        el.addEventListener("click", () => {
          data.activePhaseId = phase.id;
          render();
        });
        sb.appendChild(el);
      });

      if (getEditMode()) {
        const add = document.createElement("div");
        add.className = "phase-item";
        add.innerHTML = `<button class="btn" style="width:100%;">+ Add Phase</button>`;
        add.querySelector("button").addEventListener("click", () => {
          const title = prompt("New phase title:", `Phase ${data.phases.length+1}`);
          if (!title) return;
          data.phases.push({ id: genId(), title: title.trim(), steps: [] });
          data.activePhaseId = data.phases[data.phases.length-1].id;
          saveData();
        });
        sb.appendChild(add);
      }
    }

    function statusClass(s) {
      return s; // maps to CSS classes: not_started, in_progress, completed, blocked
    }

    function renderMainPanel() {
      const panel = $("#mainPanel");
      const active = data.phases.find(p => p.id === data.activePhaseId) || data.phases[0];
      if (!active) {
        panel.innerHTML = `<div class="muted">No phases yet. Click <b>Edit</b> and add your first phase.</div>`;
        return;
      }
      const agg = aggregatePhase(active);

      // Phase header
      const frag = document.createDocumentFragment();
      const header = document.createElement("div");
      header.className = "phase-headline";
      header.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <h2 style="margin:0;">${escapeHtml(active.title)}</h2>
          <span class="status-badge ${agg.status}">${STATUS_LABEL[agg.status]}</span>
        </div>
        <div class="right">
          <div class="muted">${active.steps.length} steps • ${agg.pct}% complete</div>
          ${getEditMode() ? `
            <button class="btn" id="renamePhaseBtn">Rename</button>
            <button class="btn" id="deletePhaseBtn">Delete</button>
          ` : ""}
        </div>
      `;
      frag.appendChild(header);

      // Steps
      const stepsContainer = document.createElement("div");
      stepsContainer.id = "stepsContainer";

      active.steps.forEach((step) => {
        const sa = aggregateStep(step);
        const stepEl = document.createElement("div");
        stepEl.className = "step";
        stepEl.innerHTML = `
          <div class="step-top">
            <div class="step-title">${escapeHtml(step.title)}</div>
            <div class="step-meta">
              <span class="step-status-chip ${statusClass(sa.status)}">${STATUS_LABEL[sa.status]}</span>
              <span class="muted">${sa.pct}%</span>
              ${getEditMode() ? `
                <button class="iconbtn" title="Rename step" data-action="rename-step"Delete step" data         </div>
          </div>
          <div class="divider"></div>
          <div class="tasklist"></div>
          ${getEditMode() ? `<div style="margin-top:8px;"><button class="btn" data-action="add-task        `;
        // Tasks
        const tl = stepEl.querySelector(".tasklist");
        (step.tasks || []).forEach(task => {
          tl.appendChild(renderTaskRow(step, task));
        });

        // Wire step-level actions
        stepEl.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          if (!btn) return;
          const action = btn.dataset.action;
          if (action === "rename-step") {
            const name = prompt("Rename step:", step.title);
            if (!name) return;
            step.title = name.trim();
            saveData();
          } else if (action === "delete-step") {
            if (!confirm("Delete this step and its tasks?")) return;
            active.steps = active.steps.filter(s => s !== step);
            saveData();
          } else if (action === "add-task") {
            const tTitle = prompt("Task title:", "New task");
            if (!tTitle) return;
            step.tasks = step.tasks || [];
            step.tasks.push({ id: genId(), title: tTitle.trim(), status: "not_started", updatedAt: nowISO() });
            saveData();
          }
        });

        stepsContainer.appendChild(stepEl);
      });

      if (getEditMode()) {
        const addStepBox = document.createElement("div");
        addStepBox.style = "margin: 10px 6px;";
        addStepBox.innerHTML = `<button class="btn">+ Add Step</button>`;
        addStepBox.querySelector("button").addEventListener("click", () => {
          const title = prompt("New step title:", `Step ${active.steps.length+1}`);
          if (!title) return;
          active.steps.push({ id: genId(), title: title.trim(), tasks: [] });
          saveData();
        });
        stepsContainer.appendChild(addStepBox);
      }

      frag.appendChild(stepsContainer);
      panel.innerHTML = ""; panel.appendChild(frag);

      // Phase header actions
      if (getEditMode()) {
        $("#renamePhaseBtn")?.addEventListener("click", () => {
          const name = prompt("Rename phase:", active.title);
          if (!name) return;
          active.title = name.trim(); saveData();
        });
        $("#deletePhaseBtn")?.addEventListener("click", () => {
          if (!confirm("Delete this phase and everything inside it?")) return;
          data.phases = data.phases.filter(p => p !== active);
          data.activePhaseId = data.phases[0]?.id || null;
          saveData();
        });
      }
    }

    function renderTaskRow(step, task) {
      const row = document.createElement("div");
      row.className = "task";
      row.dataset.taskId = task.id;
      row.innerHTML = `
        <div class="slot">
          <button class="iconbtn" title="Delete task" data-actions="slot">
          <input class="title" type="text" value="${escapeAttr(task.title)}" ${getEditMode() ? "" : "readonly"} />
        </div>
        <div class="slot chips">
          ${STATUS.map(s => `
            <span class="chip ${s} ${task.status===s ? "active" : ""}" data-status="${s}">
              ${STATUS_LABEL[s]}
            </span>
          `).join("")}
        </div>
      `;
      // Events
      const titleInput = row.querySelector(".title");
      titleInput.addEventListener("change", () => {
        if (!getEditMode()) return;
        task.title = titleInput.value.trim();
        task.updatedAt = nowISO();
        saveData();
      });

      row.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (btn?.dataset.action === "delete-task") {
          if (!getEditMode()) return;
          if (!confirm("Delete this task?")) return;
          step.tasks = (step.tasks || []).filter(t => t !== task);
          saveData();
          return;
        }
        const chip = e.target.closest(".chip");
        if (chip) {
          // status change allowed in or out of edit mode for convenience
          task.status = chip.dataset.status;
          task.updatedAt = nowISO();
          saveData();
        }
      });

      return row;
    }

    function render() {
      appRoot.setAttribute("data-edit", getEditMode() ? "true" : "false");
      renderPhasesSidebar();
      renderMainPanel();
    }

    /**********************
     * Edit Mode
     **********************/
    const getEditMode = () => localStorage.getItem(LS_KEY + "_edit") === "true";
    const setEditMode = (v) => localStorage.setItem(LS_KEY + "_edit", v ? "true" : "false");

    /**********************
     * Export (PNG / PDF)
     **********************/
    async function exportPNG() {
      const node = document.getElementById("exportTarget");
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: getComputedStyle(document.body).backgroundColor });
      const dataUrl = canvas.toDataURL("image/png");
      downloadDataUrl(dataUrl, `roadmap_${new Date().toISOString().slice(0,10)}.png`);
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const node = document.getElementById("exportTarget");
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: "#0b1220" });
      const imgData = canvas.toDataURL("image/png");

      // Letter size in points (72 pt/in) — 612 x 792
      const pdf = new jsPDF("p", "pt", "letter");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const margin = 24;
      const usableWidth = pageWidth - 2 * margin;

      // Scale image to page width
      const imgWidth = usableWidth;
      const imgHeight = canvas.height * (imgWidth / canvas.width);

      if (imgHeight <= pageHeight - 2 * margin) {
        pdf.addImage(imgData, "PNG", margin, margin, imgWidth, imgHeight);
      } else {
        // Multi-page: slice vertically
        let remainingHeight = imgHeight;
        let position = margin;
        let sY = 0; // source y on canvas
        const pageUsableHeight = pageHeight - 2 * margin;
        const ratio = imgWidth / canvas.width; // px -> pt conversion based on width scaling
        const sliceHeightPx = Math.floor(pageUsableHeight / ratio);

        while (remainingHeight > 0) {
          const canvasSlice = document.createElement("canvas");
          canvasSlice.width = canvas.width;
          canvasSlice.height = Math.min(sliceHeightPx, canvas.height - sY);
          const ctx = canvasSlice.getContext("2d");
          ctx.drawImage(canvas, 0, sY, canvas.width, canvasSlice.height, 0, 0, canvas.width, canvasSlice.height);
          const sliceData = canvasSlice.toDataURL("image/png");
          const sliceHeightPt = canvasSlice.height * ratio;

          pdf.addImage(sliceData, "PNG", margin, margin, imgWidth, sliceHeightPt);

          sY += canvasSlice.height;
          remainingHeight -= pageUsableHeight;
          if (remainingHeight > 0) pdf.addPage();
        }
      }

      pdf.save(`roadmap_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function downloadDataUrl(dataUrl, filename) {
      const a = document.createElement("a");
      a.href = dataUrl; a.download = filename; a.click();
    }

    /**********************
     * Import / Export JSON
     **********************/
    function exportJSON() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `roadmap_data_${new Date().toISOString().slice(0,10)}.json`;
      a.click(); URL.revokeObjectURL(url);
    }

    function importJSON() {
      const input = document.createElement("input");
      input.type = "file"; input.accept = "application/json";
      input.onchange = () => {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const imported = JSON.parse(reader.result);
            if (!imported.phases || !Array.isArray(imported.phases)) throw new Error("Invalid file");
            data = imported;
            if (!data.activePhaseId && data.phases[0]) data.activePhaseId = data.phases[0].id;
            saveData();
          } catch (e) {
            alert("Invalid JSON file.");
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    /**********************
     * Misc helpers
     **********************/
    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s) { return escapeHtml(s); }

    /**********************
     * Event wiring
     **********************/
    function init() {
      // Edit mode toggle
      const toggle = $("#toggleEdit");
      toggle.addEventListener("click", () => {
        setEditMode(!getEditMode());
        toggle.textContent = getEditMode() ? "Done" : "Edit";
        render();
      });
      toggle.textContent = getEditMode() ? "Done" : "Edit";

      // Exports
      $("#exportPNG").addEventListener("click", exportPNG);
      $("#exportPDF").addEventListener("click", exportPDF);
      $("#exportJSON").addEventListener("click", exportJSON);
      $("#importJSON").addEventListener("click", importJSON);
      $("#resetData").addEventListener("click", resetData);

      // Theme
      const themePicker = $("#themePicker");
      const savedTheme = localStorage.getItem(LS_KEY + "_theme") || "azure";
      document.body.setAttribute("data-theme", savedTheme);
      themePicker.value = savedTheme;
      themePicker.addEventListener("change", () => {
        document.body.setAttribute("data-theme", themePicker.value);
        localStorage.setItem(LS_KEY + "_theme", themePicker.value);
      });

      render();
    }
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
